name: ğŸš€ CI/CD Quiz Multijoueur

# Se dÃ©clenche au push sur main et develop
# Se dÃ©clenche lorsque d'une pr est crÃ©e sur la branche main
on:
  push:
    branches: [ main, develop ] 
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

# Utile pour garder ne pas utilser les derniÃ¨re versions qui nÃ©cessite peut etre de changer la pipeline
env:
  TF_VERSION: '1.6.0'
  ANSIBLE_VERSION: '8.0.0'
  NODE_VERSION: '18'

jobs: 
  terraform-security:
    name: ğŸ”’ SÃ©curitÃ© Terraform
    runs-on: ubuntu-latest
    steps:
      # Met le code dans la vm
      - name: Checkout code
        uses: actions/checkout@v4
      # Installe terraform sur la vm avec la version
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # Corrige si erreur de formatage
      - name: Terraform format check
        run: |
          cd infrastructure/terraform
          terraform fmt -check -recursive

      # TÃ©lÃ©charge et instale TFlint
      - name: Install TFLint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      # Lance TFlint, qui vÃ©rifie la logique de la terraform, s'il peut s'executer correctement
      # Le paramÃ¨tre --minimun-failure-severity=error permet de ne pas casser la pipeline sur des warning, que sur des erreurs
      - name: Run TFLint
        run: |
          cd infrastructure/terraform
          tflint --init
          tflint --format compact --minimum-failure-severity=error
      
      - name: Install Checkov
        run: |
          pip3 install checkov
      # Lance Checkov qui vÃ©rfie l'aspect sÃ©curitaire 
      - name: Run Checkov
        run: |
          cd infrastructure/terraform
          checkov -d . --framework terraform --output cli --config-file .checkov.yml
  
  ansible-validation:
    name: ğŸ­ Validation Ansible
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip3 install ansible==${{ env.ANSIBLE_VERSION }}
          pip3 install ansible-lint

      - name: Create dummy hosts.ini for syntax check
        run: |
          mkdir -p infrastructure/ansible/inventory
          echo "[web_servers]" > infrastructure/ansible/inventory/hosts.ini
          echo "127.0.0.1 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/key.pem" >> infrastructure/ansible/inventory/hosts.ini
          echo "[api_servers]" >> infrastructure/ansible/inventory/hosts.ini
          echo "127.0.0.1 ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/key.pem" >> infrastructure/ansible/inventory/hosts.ini
      
      - name: Ansible syntax check
        run: |
          cd infrastructure/ansible
          ansible-playbook --syntax-check playbook.yml -i inventory/hosts.ini
      # VÃ©rifie les bonnes pratique
      - name: Ansible lint
        run: |
          cd infrastructure/ansible
          ansible-lint playbook.yml

  build:
    name: ğŸ“¦ Package
    runs-on: ubuntu-latest
    needs: [terraform-security, ansible-validation]
    # Resttriction pour crÃ©er un package de la version que sur la version dÃ©ployer sur main
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          echo "ğŸ“¦ CrÃ©ation du package de dÃ©ploiement"
          
          # CrÃ©er l'archive de dÃ©ploiement
          mkdir -p deploy-package
          
          # Backend
          cp -r backend deploy-package/
          
          # Frontend  
          cp -r frontend deploy-package/
          
          # Infrastructure
          cp -r infrastructure deploy-package/
          
          # CrÃ©er l'archive
          tar -czf quiz-app-$(date +%Y%m%d-%H%M%S).tar.gz deploy-package/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quiz-app-build
          path: quiz-app-*.tar.gz
          retention-days: 30

  check-terraform-changes:
    name: ğŸ” VÃ©rification Changements Terraform
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3

      - name: Terraform Init
        run: make init

      - name: Terraform Plan et DÃ©tection Changements
        id: plan
        run: |
          cd infrastructure/terraform
          terraform plan -detailed-exitcode -out=tfplan
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Aucun changement infrastructure dÃ©tectÃ© - Ansible va Ãªtre exÃ©cutÃ©"
          elif [ $exit_code -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Changements infrastructure dÃ©tectÃ©s - Pipeline arrÃªtÃ©e pour approbation manuelle"
            echo "ğŸ“‹ Pour appliquer les changements: exÃ©cutez 'make apply' manuellement"
          else
            echo "âŒ Erreur lors du plan Terraform"
            exit $exit_code
          fi

      - name: Upload Terraform Plan
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: infrastructure/terraform/tfplan

  infrastructure-changes-detected:
    name: ğŸ›‘ Changements Infrastructure DÃ©tectÃ©s - Action Manuelle Requise
    runs-on: ubuntu-latest
    needs: [check-terraform-changes]
    if: needs.check-terraform-changes.outputs.has_changes == 'true'
    steps:
      - name: Infrastructure Changes Detected
        run: |
          echo "ğŸ›‘ ATTENTION: Changements d'infrastructure dÃ©tectÃ©s!"
          echo ""
          echo "ğŸ“‹ Actions requises:"
          echo "1. Examinez le plan Terraform dans les artifacts"
          echo "2. Si les changements sont corrects, exÃ©cutez manuellement:"
          echo "   - git pull"
          echo "   - make init"
          echo "   - make apply"
          echo ""
          echo "âŒ Le pipeline s'arrÃªte ici pour Ã©viter des changements automatiques non dÃ©sirÃ©s"
          echo ""
          echo "â„¹ï¸  Une fois l'infrastructure mise Ã  jour manuellement, la prochaine exÃ©cution"
          echo "   du pipeline dÃ©ploiera automatiquement l'application avec Ansible"
          exit 1

  deploy-application:
    name: ğŸš€ DÃ©ploiement Application avec Ansible
    runs-on: ubuntu-latest
    needs: [check-terraform-changes]
    if: needs.check-terraform-changes.outputs.has_changes == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Ansible
        run: |
          pip3 install ansible==${{ env.ANSIBLE_VERSION }}
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
        
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/quiz-app-key.pem
          chmod 600 ~/.ssh/quiz-app-key.pem
      
      - name: Generate hosts.ini and Deploy Application
        run: |
          echo "ğŸš€ DÃ©ploiement de l'application avec make deploy..."
          make deploy
          echo "âœ… Application dÃ©ployÃ©e avec succÃ¨s"